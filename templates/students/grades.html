{% extends "base.html" %}

{% load static %}

{% block body_class %}grades-page{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/students-new.css' %}">
<link rel="stylesheet" href="{% static 'css/grades-new.css' %}">
{% endblock %}

{% block content %}
<!-- GRADES PAGE CONTENT - Uses global 3-column layout from base.html -->
<div class="grades-content-wrapper">
    <!-- LEFT: Student Directory List -->
    <div class="students-directory-panel">
        <div class="course-filter-section">
            <label class="course-filter-label">Course</label>
            <select class="course-filter-dropdown" id="courseFilterDropdown">
                <option value="all">All Courses</option>
                <option value="Philosophy">Philosophy</option>
                <option value="Social Studies">Social Studies</option>
                <option value="Psychology">Psychology</option>
            </select>
        </div>
        <div class="students-list-container" id="studentsListContainer">
            <!-- Data populated by JS -->
        </div>
    </div>

    <!-- CENTER: Grading Interface -->
    <div class="grading-main">
        <div class="report-card-container">
            <!-- Student Header (Gold Ribbon) -->
            <div class="student-header-card" id="studentHeaderCard">
                <img src="#" alt="Student Avatar" class="student-header-avatar" id="headerAvatar">
                <div class="student-header-info">
                    <div class="header-main-row">
                        <h2 id="headerName">Select a Student</h2>
                    </div>
                    <div class="student-header-tags" id="headerTags">
                        <span class="header-tag course-tag" id="headerCourseTag">--</span>
                        <span class="header-tag special-tag">IB Candidate</span>
                    </div>
                </div>
            </div>

            <!-- Grades Matrix Section -->
            <div class="grading-section">
                <div class="grading-header-row">
                    <h2 class="grading-title" id="gradingTitle">Philosophy Grades</h2>
                    <button type="button" class="add-col-btn" onclick="addGradeColumn()">Add new column</button>
                </div>

                <div class="grading-matrix-container">
                    <table class="grading-matrix" id="gradingMatrix">
                        <thead>
                            <tr>
                                <th class="row-header"></th>
                                <!-- Date Headers rendered by JS -->
                            </tr>
                        </thead>
                        <tbody id="gradingBody">
                            <!-- Rows rendered by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="grading-footer">
                    <button type="button" class="add-eval-btn" onclick="addEvaluationRow()">+ Add Evaluation</button>
                </div>
            </div>

            <!-- Teacher's Log Section (in center content for grades) -->
            <div class="teachers-log-card">
                <div class="teachers-log-header">
                    <h4>Teacher's Log</h4>
                    <button type="button" class="pdf-btn" title="Send to PDF" onclick="exportLogToPDF()">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
                <div class="log-entries" id="logEntries">
                    <!-- Log entries rendered by JS -->
                </div>
                <button type="button" class="show-more-btn" id="showMoreLogsBtn" onclick="openLogsPopup()"
                    style="display: none;">
                    Show More
                </button>
                <div class="log-input-area">
                    <textarea class="log-input" id="newLogInput" placeholder="Add a behavioral note..."></textarea>
                    <button type="button" class="add-note-btn" onclick="addLogNote()">Add Note</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event View Popup -->
<div class="event-view-popup-overlay" id="eventViewPopup">
    <div class="event-view-popup">
        <div class="event-view-popup-header">
            <h3><i class="fas fa-calendar-day"></i> <span id="eventPopupDate">Events</span></h3>
            <button type="button" class="event-popup-close" onclick="closeEventPopup()" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="event-view-popup-body" id="eventPopupBody"></div>
    </div>
</div>

<!-- Logs Popup -->
<div class="modal-overlay" id="logsFullPopup">
    <div class="modal-content logs-popup-content">
        <div class="modal-header">
            <h2>Teacher's Log History</h2>
            <button type="button" class="modal-close" onclick="closeLogsPopup()" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body logs-popup-body">
            <div class="logs-popup-layout">
                <div class="logs-popup-calendar">
                    <div class="logs-cal-header">
                        <button type="button" onclick="navigateLogsCalendar(-1)" aria-label="Previous Month">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="logsCalendarTitle">December 2025</span>
                        <button type="button" onclick="navigateLogsCalendar(1)" aria-label="Next Month">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="logs-cal-weekdays">
                        <span>Su</span><span>M</span><span>Tu</span><span>W</span><span>Th</span><span>F</span><span>Sa</span>
                    </div>
                    <div class="logs-cal-days" id="logsCalendarDays"></div>
                </div>
                <div class="logs-popup-entries">
                    <h4>Recent Notes</h4>
                    <div id="logsPopupList"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script id="server-students-data" type="application/json">{{ students_json|safe }}</script>
<script id="server-events-data" type="application/json">[]</script>
<script id="server-courses-data" type="application/json">{{ courses_json|safe }}</script>
<script id="teacher-first-name" type="application/json">"{{ teacher_first_name|default:'Demo' }}"</script>
<script>
    const serverStudentsData = JSON.parse(document.getElementById('server-students-data').textContent);
    const serverEventsData = JSON.parse(document.getElementById('server-events-data').textContent);
    const serverCoursesData = JSON.parse(document.getElementById('server-courses-data').textContent);
    const teacherFirstName = JSON.parse(document.getElementById('teacher-first-name').textContent);
</script>
<script src="{% static 'js/grades-new.js' %}"></script>
{% endblock %}